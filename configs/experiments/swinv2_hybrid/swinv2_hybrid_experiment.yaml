# SwinV2 Hybrid Architecture Experiment Configuration
#
# This configuration defines the specific overrides for the SwinV2 + ASPP + CNN
# hybrid architecture experiment, inheriting from the standard base.yaml.
#
# Architecture: SwinV2CnnAsppUNet
# Loss: FocalDiceLoss (focal_weight=0.6, dice_weight=0.4)
# Target: Optimize for thin crack detection (1-5 pixels wide)
#
# Hardware: Optimized for RTX 3070 Ti (8GB VRAM)
# Expected Performance: IoU > 0.85, F1 > 0.90 on crack segmentation tasks

# Inherit from base configuration and apply specific overrides
defaults:
  - /base  # Include base configuration first
  - /model: default
  - /data: default
  - /data/transform: augmentations
  - /data/dataloader: default
  - /evaluation: default
  - _self_ # This file's overrides (highest priority)

# General project settings (from base)
project_name: "crack-segmentation"
output_dir: artifacts/
data_dir: data/
random_seed: 42
seed: 42
debug: false

# Experiment configuration
experiment:
  name: "swinv2_hybrid_experiment"
  output_dir: "artifacts/experiments/${now:%Y%m%d-%H%M%S}-swinv2_hybrid_experiment"
  timestamp: true

# Experiment-specific hydra configuration
hydra:
  # Configure output directory generation
  runtime:
    output_dir: ${experiment.output_dir}
  # Configure experiment ID for proper tracking
  job:
    name: ${experiment.name}
    chdir: false

# Model architecture overrides for SwinV2 hybrid
model:
  _target_: crackseg.model.architectures.swinv2_cnn_aspp_unet.SwinV2CnnAsppUNet
  type: "SwinV2CnnAsppUNet"
  encoder:
    _target_: crackseg.model.encoder.swin_v2_adapter.SwinV2EncoderAdapter
    model_name: "swinv2_tiny_window8_256"
    img_size: 256
    target_img_size: 256
    in_channels: 3
  bottleneck:
    _target_: crackseg.model.components.aspp.ASPPModule
    in_channels: 768
    output_channels: 256
    dilation_rates: [1, 6, 12, 18]
    dropout_rate: 0.1
  decoder:
    _target_: crackseg.model.decoder.cnn_decoder.CNNDecoder
    in_channels: 256
    config:
      use_cbam: true
      cbam_reduction: 16
      upsample_mode: "bilinear"
      kernel_size: 3
      padding: 1
      upsample_scale_factor: 2
  num_classes: 1
  final_activation: "sigmoid"

# Training configuration overrides for SwinV2 hybrid
training:
  # Training parameters that override trainer.yaml
  epochs: 3  # Reduced for verification testing
  learning_rate: 0.0001
  batch_size: 4  # Optimized for RTX 3070 Ti (8GB VRAM)
  num_workers: 4
  gradient_accumulation_steps: 1
  use_amp: true

  # Device configuration
  device: "auto"
  require_cuda: false

  # Checkpoint configuration
  checkpoint_dir: "artifacts/experiments"
  save_freq: 5
  save_best: true
  monitor_metric: "val_loss"
  monitor_mode: "min"

  # Early stopping configuration
  early_stopping_patience: 15
  early_stopping:
    _target_: crackseg.utils.training.early_stopping.EarlyStopping
    enabled: True
    patience: 10
    min_delta: 0.001
    mode: "min"
    monitor_metric: "val_loss"
    verbose: True

  # Logging configuration
  logging:
    log_freq: 10
    tensorboard: true
    wandb: false

  # Validation configuration
  validation:
    freq: 1
    save_predictions: true
    save_visualizations: true
  loss:
    _target_: crackseg.training.losses.focal_dice_loss.FocalDiceLoss
    config:
      _target_: crackseg.training.losses.focal_dice_loss.FocalDiceLossConfig
      focal_weight: 0.6
      dice_weight: 0.4
      focal_alpha: 0.25
      focal_gamma: 2.0
      focal_reduction: "mean"
      dice_smooth: 1.0
      dice_sigmoid: true
      dice_eps: 1e-6
      total_loss_weight: 1.0
  optimizer:
    _target_: torch.optim.Adam
    lr: 0.0001
    weight_decay: 0.01
    betas: [0.9, 0.999]
  scheduler:
    _target_: torch.optim.lr_scheduler.CosineAnnealingWarmRestarts
    T_0: 10
    T_mult: 2
    eta_min: 1e-6

# Data configuration overrides for SwinV2 hybrid
data:
  data_root: data/unified/
  root_dir: data/unified/
  train_split: 0.7
  val_split: 0.15
  test_split: 0.15
  seed: 42
  in_memory_cache: False  # Deshabilitado temporalmente
  use_unified_splitting: True
  image_size: [256, 256]
  dataloader:
    batch_size: 4
    num_workers: 4
    pin_memory: true
    persistent_workers: true
    prefetch_factor: 2
    drop_last: true