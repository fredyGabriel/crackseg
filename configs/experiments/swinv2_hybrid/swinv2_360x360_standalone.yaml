# SwinV2 Hybrid 360x360 Experiment - Standalone Configuration
# Complete configuration without base defaults

defaults:
  - _self_

experiment:
  name: swinv2_360x360_standalone

hydra:
  job:
    name: swinv2_hybrid_360x360_experiment
    chdir: false
  run:
    dir: artifacts/experiments/${now:%Y%m%d-%H%M%S}-swinv2_hybrid_360x360_experiment

# Model Configuration - SwinV2CnnAsppUNet
model:
  _target_: crackseg.model.architectures.swinv2_cnn_aspp_unet.SwinV2CnnAsppUNet
  encoder_cfg:
    model_name: swinv2_tiny_window8_256
    img_size: 360
    target_img_size: 360
    in_channels: 3
    pretrained: true
  bottleneck_cfg:
    out_channels: 256
    atrous_rates: [1, 6, 12, 18]
    dropout_rate: 0.1
  decoder_cfg:
    use_cbam: true
    cbam_reduction: 16
    upsample_mode: bilinear
    kernel_size: 3
    padding: 1
    upsample_scale_factor: 2
  num_classes: 1
  final_activation: sigmoid

# Data Configuration
data:
  data_root: data/crack500/
  root_dir: data/crack500/
  train_split: 0.7
  val_split: 0.15
  test_split: 0.15
  seed: 42
  in_memory_cache: false
  use_unified_splitting: true
  transform:
    train:
      - name: Resize
        params:
          height: 360
          width: 360
      - name: HorizontalFlip
        params:
          p: 0.5
      - name: VerticalFlip
        params:
          p: 0.5
      - name: Rotate
        params:
          limit: 90
          p: 0.5
      - name: ColorJitter
        params:
          brightness: 0.2
          contrast: 0.2
          saturation: 0.2
          hue: 0.1
          p: 0.3
      - name: Normalize
        params:
          mean: [0.485, 0.456, 0.406]
          std: [0.229, 0.224, 0.225]
      - name: ToTensorV2
        params: {}
    val:
      - name: Resize
        params:
          height: 360
          width: 360
      - name: Normalize
        params:
          mean: [0.485, 0.456, 0.406]
          std: [0.229, 0.224, 0.225]
      - name: ToTensorV2
        params: {}
    test:
      - name: Resize
        params:
          height: 360
          width: 360
      - name: Normalize
        params:
          mean: [0.485, 0.456, 0.406]
          std: [0.229, 0.224, 0.225]
      - name: ToTensorV2
        params: {}
  image_size: [360, 360]
  # Required dimensions
  num_dims_image: 4
  num_channels_rgb: 3
  num_dims_mask: 3
  kernel_expected_dims: 2
  expected_input_dims: 4
  expected_bottleneck_ndim_4d: 4
  expected_bottleneck_ndim_3d: 3
  num_dims_mask_pre_unsqueeze: 3

  # Dataloader configuration
  dataloader:
    batch_size: 12
    num_workers: 6
    shuffle: true
    pin_memory: true
    prefetch_factor: 3
    drop_last: true
    persistent_workers: true
    distributed:
      enabled: false
      rank: 0
      world_size: 1
    sampler:
      enabled: false
      kind: random
      shuffle: true
      seed: 42
    memory:
      fp16: false
      adaptive_batch_size: false

# Training Configuration
training:
  epochs: 3  # Reduced for testing
  learning_rate: 5.0e-05
  batch_size: 12
  num_workers: 6
  gradient_accumulation_steps: 2
  use_amp: true
  device: auto
  require_cuda: false
  checkpoint_dir: artifacts/experiments
  save_freq: 5
  save_best: true
  monitor_metric: val_iou
  monitor_mode: max
  early_stopping_patience: 25

  # Early stopping
  early_stopping:
    enabled: true
    patience: 25
    min_delta: 0.0005
    mode: max
    monitor_metric: val_iou
    verbose: true
    should_stop: false

  # Logging
  logging:
    log_freq: 5
    tensorboard: true
    tensorboard_dir: artifacts/experiments/tensorboard
    wandb: false
    wandb_project: crack-segmentation
    wandb_entity: null
    wandb_run_name: swinv2_hybrid_360x360_experiment
    save_model_architecture: true
    log_gradients: false
    log_model_weights: false
    log_learning_rate: true
    log_images: true
    log_predictions: true
    image_log_freq: 10
    num_images_to_log: 8

  # Validation
  validation:
    freq: 1
    save_predictions: true
    save_visualizations: true

  # Loss - Using BCEDiceLoss which exists
  loss:
    _target_: crackseg.training.losses.BCEDiceLoss
    type: bce_dice
    bce_weight: 0.5
    dice_weight: 0.5
    smooth: 1.0
    config:
      _target_: crackseg.training.losses.bce_dice_loss.BCEDiceLossConfig
      bce_weight: 0.5
      dice_weight: 0.5
      dice_smooth: 1.0
      dice_sigmoid: true
      dice_eps: 1.0e-06
      bce_reduction: mean

  # Optimizer
  optimizer:
    _target_: torch.optim.AdamW
    lr: 5.0e-05
    weight_decay: 0.005
    betas: [0.9, 0.999]
    eps: 1.0e-08

  # Scheduler
  scheduler:
    type: cosine
    T_0: 30
    T_mult: 1
    eta_min: 1.0e-07

  # LR Scheduler
  lr_scheduler:
    _target_: torch.optim.lr_scheduler.CosineAnnealingWarmRestarts
    T_0: 30
    T_mult: 1
    eta_min: 1.0e-07

  # Other training params
  grad_clip: 1.0
  weight_decay: 0.005
  step_size: 10
  gamma: 0.5

# Evaluation Configuration
evaluation:
  batch_size: 8
  num_workers: 4
  device: auto
  threshold: 0.5
  save_predictions: true
  save_visualizations: true
  save_metrics: true
  save_masks: true
  save_overlay: true
  compute_per_class: false
  multi_threshold: false
  prediction_format: numpy
  save_dir: artifacts/experiments
  mode: test

  # Visualization
  visualization:
    enabled: true
    save_dir: artifacts/experiments/visualizations
    save_freq: 10
    num_samples: 8
    overlay_alpha: 0.5
    colormap: viridis
    show_grid: true
    save_format: png
    show_ground_truth: true
    show_predictions: true
    show_overlay: true

  # Dataset
  dataset:
    split: test
    shuffle: false
    drop_last: false

  # Report
  report:
    generate: true
    format: json
    include_confusion_matrix: true
    include_classification_report: true
    include_per_image_metrics: false
    save_to_file: true
    file_path: artifacts/experiments/evaluation_report.json

  # Additional settings
  additional_settings:
    compute_confusion_matrix: true
    save_detailed_metrics: true
    export_results: true

# Experiment Configuration
experiment:
  name: swinv2_hybrid_360x360_experiment
  output_dir: artifacts/experiments



# Project Configuration
project_name: crack-segmentation
output_dir: artifacts/
data_dir: data/
random_seed: 42
seed: 42
debug: false
log_level: INFO
log_to_file: true
require_cuda: false
device: auto

# Memory settings
memory:
  gradient_checkpointing: false
  empty_cache_freq: 100
  monitor_memory: false

# Hardware settings
hardware:
  cudnn_benchmark: true
  cudnn_deterministic: false
  mixed_precision: false
  memory_efficient_attention: false

# Timestamp parsing
timestamp_parsing:
  min_parts: 2
  date_len: 8
  time_len: 6

# Thresholds
thresholds:
  default: 0.5
  metric: 0.5
  loss_weight: 0.5
  gamma: 0.5

# Visualization
visualization:
  num_cols: 3
  num_cols_no_targets: 2
